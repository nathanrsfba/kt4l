# Tools #

Tools found in this directory:

## cfgtemplate ##

This reads a set of configuration files provided on the command line, which
should be a series of lines in KEY=VALUE pairs, and lines starting with #
symbols are comments. It then reads stdin, replaces any instances of %KEY% with
the corresponding VALUE.

This serves two purposes. Firstly, the configuration files can be stored in
version control, separate from the password. The "actual" configuration files
will be generated by launch scripts, using this tool. Secondly, values common
to more than one configuration file can be stored once.

## launch ##

This will launch the radio server, performing a few tasks beforehand to set
everything up. This includes generating the actual configuration files in /tmp
from the templates in config/, making sure the log directory exists, and making
sure the password file is not world readable.

## mp3index ##

This creates an HTML index of the files in the library. It takes two command
line parameters: A template file, which is used to generate the HTML, and the
directory to index for MP3 files. The output will be printed to stdout.

The template file should be an HTML file containing the desired HTML content.
There should be a single line containing placeholders in the form of %link% (an
href linking to the file), %title% (track title), and %artist% (track artist).
The script will repeat this line once for each file, replacing the placeholders
as appropriate.

The directory should contain the root of the library directory. All links will
be relative to what appears here; in the case of Deliria, this should be run
from the library directory, and the directory should just be '.'.

## reindex ##

A short shell script that runs mp3index to regen the library index

## mod2mp3 ##

A shell script that converts module files to MP3 using openmpt123 and lame. It
takes a list of files on the command line, outputs converted files in the same
directory as the original, with an extension of .mp3. It ignores files that
already appear to have been converted (i.e. an .mp3 already exists),
specifically ignores .mp3 files, and tests whether openmpt123 recognizes it
before attempting conversion, so you can happily pass it * in a directory that
has already been partially converted.

It passes options to lame to set the ID3 encoding. By default, the title is
taken from the filename, and the artist and album are left blank.

It takes the following command line options:

* -a: Encode using ABR (average bitrate). Default is CBR.
* -F: Take artist name from folder of original file. This sets the artist
  properly if the modules are grouped into folders by artist.  
* -N: Take both title and artist from filename. This expects the file to be
  named in 'title - artist' form.
* -f freq: Frequency to render in (default: 44100)
* -c chan: Channels: 1 or 2 (default: 2)
* -b rate: MP3 bitrate to encode in (default: 128)
* -A artist: Name of artist to place in ID3 tags. This will set the artist for
  all files given on the command line.
* -L album: Name of album to place in ID3 tags. This will set the album for all
  files given

## nextrak ##

A horribly overengineered Python script that selects the next song to be
played. This is intended to be used as the 'playlist program' in the ezstream
configuration. It chooses the next track to play.

The main program lives in the file 'nextrak'. It loads a list of all the files
in the music library folder, and stores information about all of them in a JSON
structure. It removes any files that don't exist from the database, adds any
that weren't present on the previous run, and updates the information on any
that have been changed, or moved to another folder.

It then imports selector.py: This has four functions:

readTrack: Called when a track is added or updated in the database. Any
information that the selector needs (from ID3 tags, etc) should be grabbed here
and inserted in the database.

preSelect: Does anything that might need to be done before selecting a track.

weighTrack: Called for every track in the system to give it a priority and
weight. See the docstring in selector.py for details.

postSelect: Does anything that might need to be done after selecting a track.

This is flexible enough to potentially play certain tracks more often than
others, insert jingles or ads at particular times, or any number of other
possibilities.

The selector.py file should contain all the acutal customization, and track
selection code. Right now, it gives all tracks played in the previous 3 hours a
low priority (so they're not played), and gives any tracks in the 'deliria'
subfolder a lower weight.

## nextrak-kludge ##

This is a dirty hack to get around the fact that ezstream can't handle files
with single quotes in the name.

According to the ezstream documentation, when running external scripts, the
arguments passed are quoted in single quotes, with single quotes and
backslashes quoted.

This is a lie.

This script runs nextrak, gets the next track, then symlinks it to a standard
filename, which ezstream can't choke on.

