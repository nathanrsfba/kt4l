# Tools #

Tools found in this directory:

## cfgtemplate ##

This reads a set of configuration files provided on the command line, which
should be a series of lines in KEY=VALUE pairs, and lines starting with #
symbols are comments. It then reads stdin, replaces any instances of %KEY% with
the corresponding VALUE.

This serves two purposes. Firstly, the configuration files can be stored in
version control, separate from the password. The "actual" configuration files
will be generated by launch scripts, using this tool. Secondly, values common
to more than one configuration file can be stored once.

## launch ##

This will launch the radio server, performing a few tasks beforehand to set
everything up. This includes generating the actual configuration files in /tmp
from the templates in config/, making sure the log directory exists, and making
sure the password file is not world readable.

## mp3index ##

This creates an HTML index of the files in the library. It takes two command
line parameters: A template file, which is used to generate the HTML, and the
directory to index for MP3 files. The output will be printed to stdout.

The template file should be an HTML file containing the desired HTML content.
There should be a single line containing placeholders in the form of %link% (an
href linking to the file), %title% (track title), and %artist% (track artist).
The script will repeat this line once for each file, replacing the placeholders
as appropriate.

The directory should contain the root of the library directory. All links will
be relative to what appears here; in the case of Deliria, this should be run
from the library directory, and the directory should just be '.'.

## reindex ##

A short shell script that runs mp3index to regen the library index

## mod2mp3 ##

A shell script that converts module files to MP3 using openmpt123 and lame. It
takes a list of files on the command line, outputs converted files in the same
directory as the original, with an extension of .mp3. It ignores files that
already appear to have been converted (i.e. an .mp3 already exists),
specifically ignores .mp3 files, and tests whether openmpt123 recognizes it
before attempting conversion, so you can happily pass it * in a directory that
has already been partially converted.

It passes options to lame to set the ID3 encoding. By default, the title is
taken from the filename, and the artist and album are left blank.

It takes the following command line options:

* -a: Encode using ABR (average bitrate). Default is CBR.
* -F: Take artist name from folder of original file. This sets the artist
  properly if the modules are grouped into folders by artist.  
* -N: Take both title and artist from filename. This expects the file to be
  named in 'title - artist' form.
* -f freq: Frequency to render in (default: 44100)
* -c chan: Channels: 1 or 2 (default: 2)
* -b rate: MP3 bitrate to encode in (default: 128)
* -A artist: Name of artist to place in ID3 tags. This will set the artist for
  all files given on the command line.
* -L album: Name of album to place in ID3 tags. This will set the album for all
  files given

## nextrak ##

A horribly overengineered Python script that selects the next song to be
played. This is intended to be used as the 'playlist program' in the ezstream
configuration. It chooses the next track to play.

The main program lives in the file 'nextrak'. It loads a list of all the files
in the music library folder, and stores information about all of them in a JSON
structure. It removes any files that don't exist from the database, adds any
that weren't present on the previous run, and updates the information on any
that have been changed, or moved to another folder.

It defines a class called Selector, which contains the following methods:

readTrack: Called when a track is added or updated in the database. Any
information that the selector needs (from ID3 tags, etc) should be grabbed here
and inserted in the database.

preSelect: Does anything that might need to be done before selecting a track.

weighTrack: Called for every track in the system to give it a priority and
weight. See the docstring in selector.py for details.

postSelect: Does anything that might need to be done after selecting a track.

This is flexible enough to potentially play certain tracks more often than
others, insert jingles or ads at particular times, or any number of other
possibilities.

The Selector class defined in nextrak does some housekeeping, and implements
basic functionality. To customize the track selection parameters, a separate
class is defined in selector.py, and this is where all the acutal customization
should occur.

The default implementation does the following:

1. It deprioritizes any track that was played in the previous 3 hours
2. It deprioritizes any artist that was played in the past hour.

This should provide a reasonably not-too-repetetive music selection, and
demonstrates the basic idea behind customizing playback parameters.

## nextrak-kludge ##

This is a dirty hack to get around the fact that ezstream can't handle files
with single quotes in the name.

According to the ezstream documentation, when running external scripts, the
arguments passed are quoted in single quotes, with single quotes and
backslashes quoted.

This is a lie.

This script runs nextrak, gets the next track, then symlinks it to a standard
filename, which ezstream can't choke on.

If nextrak outputs more than one track to play, they will be stored in a file
called playlist.txt, which the recode script will look for upon decoding.

## queue ##

This script manages the queue of songs to play. Normally nextrak makes a
(weighted) random selection when picking a track, but this allows you to select
the next track (or tracks) to play.

The script does a 'keyword' search -- it will individually search for each word
specified on the command line. All words must be found to trigger a match. By
default checks artist, title and album for the words. So searching 'pink floyd
money' will probably do what you expect.

Command line arguments can search specifically for artist (-A), title (-T) or
album (-L) alone. In unix style, these switches all take a paremeter, and can
be specified more than once to search for more than one word in the given
field.

Keywords can be excluded using the -X argument. If any argument to -X is found,
a track will be rejected as a potential match.

Multiple-word 'keywords' can be specified by enclosing them in quotes, assuming
you're running it from a POSIX style shell.

Other argument include '-l', which list the files that match, without altering
the queue, '-r' which *removed* a track from the queue, '-p' which specifies
where in the queue to add a file, and '-m' which will move a track to another
position.

Run without arguments, it will display the current queue.

## recode ##

recode is a script that is responsible for applying effects to MP3 files before
being encoded for the stream. It is intended to replace the decode step of MP3
re-encoding (by default madplay) used by ezstream. It expects a path to a file
to decode, and no other arguments.

recode calls mpg123, applies some effects using sox, then sends the output to
stdout. These effects include trimming the start and/or end (by passing
appropriate parameters to mpg123), and fading in or out, as determined by the
appropriate ID3v2 tags in the input files. It also applies a dynamic range
compressor, producing an output of even volume.

By default, recode outputs 44.1k, 16 bit signed stereo audio, and expects lame
to be configured to accept the same. Also, the specific filters applied are
hardcoded. These can be altered by changing the 'settings' object near the top
of the script.

Furthermore, if a file called 'playlist.txt' exists in the same directory as
the supplied MP3 files, then its contents are read, and taken as a list of MP3
files to decode. They will be passed to mpg123 in a single invocation,
combining their output as if they were a single file. mpg123's gapless playback
mode should ensure that the transition between tracks is perfectly smooth.
nextrak-kludge will intercept the output from nextrak and generate such a
playlist file as necessary.

## getmeta ##

This script serves as an external metadata-retrieval script for EZStream. 

When called from EZStream, it reads the metadata.json file (by default, in the
radio root directory), figures out what track is currently playing, and returns
it to EZStream. It accepts the 'artist' and 'title' command arguments as passed
from EZStream.

When called with the -p option, it reads a list of MP3 tracks from the given
file, and creates a new metadata.json file. This should be done on each track
change, and is called as such from nextrak-kludge.

The metadata.json file contains a list of tracks in the current group, along
with their durations. It also contains the system time (in Unix timestamp
format) of the time the current group started, and with this information
calculates the currently playing track based on the system time.

## linkdirs ##

This is a quick and dirty shell script that scans a folder of music, figures
out what subfolders need to be added to the library, and symlinks them as
appropriate.

It searches the music folder for any subfolder which as a file called
'radiouse' in it, and uses the presence of this file to determine what folders
should be linked to the library. If a symlink to this folder already exists,
then the folder is ignored. If a symlink with the same name already exists, and
links to a different folder, an altername symlink name is created from the name
of the folder, along with the name of the parent folder. This is intended to
link in folders arranged in artist/album hierarchy, but also takes into account
the possibility of the same album name from different artists.

The source and target directories, as well as the the indicator file, may be
configured by changing the variables at the top of the script.

## tag ##

This is a tool to set the various custom ID3 tags used by this project from the
command line.

Run it with the -h option to see what options it can set, and also see the
"Radio Management Tags" section in the main README. If no options are given, it
will display the relevant tags for the files given.

Note that it does not deal with general ID3 tags like artist or title, as there
are other command line tools for this function.

## mpg123-kludge ##

Another stupid kludge to fix another stupid bug.

mpg123 has the option to send its output to stdout, which this project uses to
re-encode MP3s.

In mpg123, this function is broken. It displays diagnostic output to stdout.
Even in quiet mode.

To this end, a frontend has been written to work around this. It creates a
pipe in /tmp, has mpg123 output to that in the background, sends whatever
stdout garbage it outputs to stderr, then cats out the pipe, and deletes it.

This script expects the caller not to give it any options on where to output
the data, and instead prepends an -O option to the start of whatever is given.

I hate everything.
